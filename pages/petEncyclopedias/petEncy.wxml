<!-- petEncy.wxml -->
<view class="pet-encyclopedia-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="page-title">
      <text class="paw-icon">ğŸ¾</text>
      <text class="title">å® ç‰©ç™¾ç§‘</text>
    </view>
    <button class="add-button" bindtap="showAddModal">
      <text class="add-icon">+</text>
      <text>æ·»åŠ å® ç‰©ä¿¡æ¯</text>
    </button>
  </view>

  <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
  <view class="search-filter">
    <view class="search-input">
      <text class="search-icon">ğŸ”</text>
      <input
        type="text"
        value="{{searchKeyword}}"
        placeholder="æœç´¢å“ç§åç§°..."
        bindinput="handleSearch"
      />
    </view>
    <view class="filter-dropdown">
      <picker 
        mode="selector" 
        range="{{categoryOptions}}" 
        value="{{categoryIndex}}" 
        bindchange="handleFilterChange"
      >
        <view class="picker-text">
          {{categoryOptions[categoryIndex]}}
        </view>
      </picker>
    </view>
  </view>

  <!-- å® ç‰©åˆ—è¡¨ -->
  <view class="pet-list" wx:if="{{!loading && pets.length > 0}}">
    <view 
      class="pet-card pet-card--{{item.category}}" 
      wx:for="{{displayedPets}}" 
      wx:key="pet_ency_id"
      wx:for-index="idx"
    >
      <view class="pet-header">
        <text class="pet-name">{{item.variety_name}}</text>
        <view class="category-badge">{{item.category}}</view>
        <view class="pet-actions">
          <button class="edit-button" bindtap="editPet" data-pet="{{item}}">
            <text class="action-icon">âœï¸</text>
            <text>ç¼–è¾‘</text>
          </button>
          <button class="delete-button" bindtap="confirmDelete" data-pet="{{item}}">
            <text class="action-icon">ğŸ—‘ï¸</text>
            <text>åˆ é™¤</text>
          </button>
        </view>
      </view>

      <view class="pet-content">
        <view class="pet-image-container">
          <image 
            class="pet-image" 
            src="{{item.image}}" 
            mode="aspectFill"
            wx:if="{{item.image}}"
          />
          <view class="pet-image placeholder" wx:else>
            <view class="no-image">
              <text wx:if="{{item.category === 'çŒ«å’ª'}}">ğŸ±</text>
              <text wx:elif="{{item.category === 'ç‹—ç‹—'}}">ğŸ¶</text>
              <text wx:elif="{{item.category === 'å°å® '}}">ğŸ¹</text>
              <text wx:else>ğŸ¾</text>
              <text class="no-image-text">æš‚æ— å›¾ç‰‡</text>
            </view>
          </view>
        </view>

        <view class="pet-details">
          <view class="pet-info-group">
            <view class="detail-item">
              <text class="label">ä½“å‹:</text>
              <text class="value">{{item.bodily_form || 'æœªçŸ¥'}}</text>
            </view>
            <view class="detail-item">
              <text class="label">ä½“é‡:</text>
              <text class="value">{{item.weight || 'æœªçŸ¥'}}</text>
            </view>
            <view class="detail-item">
              <text class="label">å¯¿å‘½:</text>
              <text class="value">{{item.lifetime || 'æœªçŸ¥'}}</text>
            </view>
          </view>

          <view class="collapsible-section">
            <button class="toggle-button" bindtap="toggleDetails" data-index="{{idx}}">
              <text class="toggle-icon">{{item.showDetails ? 'â–¼' : 'â–¶'}}</text>
              <text>{{item.showDetails ? 'æ”¶èµ·è¯¦æƒ…' : 'æŸ¥çœ‹è¯¦æƒ…'}}</text>
            </button>

            <view class="extended-details" wx:if="{{item.showDetails}}">
              <view class="detail-columns">
                <view class="detail-column">
                  <view class="detail-item">
                    <text class="label">èº«é«˜:</text>
                    <text class="value">{{item.height || 'æœªçŸ¥'}}</text>
                  </view>
                  <view class="detail-item">
                    <text class="label">å°¾å·´ç‰¹å¾:</text>
                    <text class="value">{{item.feature_tail || 'æœªçŸ¥'}}</text>
                  </view>
                  <view class="detail-item">
                    <text class="label">è€³æœµç‰¹å¾:</text>
                    <text class="value">{{item.feature_ear || 'æœªçŸ¥'}}</text>
                  </view>
                </view>
                <view class="detail-column">
                  <view class="detail-item">
                    <text class="label">çœ¼ç›ç‰¹å¾:</text>
                    <text class="value">{{item.feature_eye || 'æœªçŸ¥'}}</text>
                  </view>
                  <view class="detail-item">
                    <text class="label">æ¯›è‰²:</text>
                    <text class="value">{{item.coat_color || 'æœªçŸ¥'}}</text>
                  </view>
                  <view class="detail-item">
                    <text class="label">æ¯›é•¿:</text>
                    <text class="value">{{item.coat_length || 'æœªçŸ¥'}}</text>
                  </view>
                </view>
              </view>
              
              <view class="detail-item description">
                <text class="label-block">ç®€ä»‹:</text>
                <view class="description-content">
                  <text>{{item.introduction || 'æš‚æ— ç®€ä»‹'}}</text>
                </view>
              </view>
              <view class="detail-item description">
                <text class="label-block">é¥²å…»æ³¨æ„äº‹é¡¹:</text>
                <view class="description-content">
                  <text>{{item.feeding_matters || 'æš‚æ— é¥²å…»æ³¨æ„äº‹é¡¹'}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:elif="{{!loading && pets.length === 0}}">
    <view class="empty-icon">ğŸ”</view>
    <text>æš‚æ— å® ç‰©ä¿¡æ¯ï¼Œç‚¹å‡»"æ·»åŠ å® ç‰©ä¿¡æ¯"æŒ‰é’®æ·»åŠ æ–°çš„å® ç‰©ç™¾ç§‘ã€‚</text>
    <button class="add-button-secondary" bindtap="showAddModal">
      <text class="add-icon">+</text>
      <text>æ·»åŠ å® ç‰©ä¿¡æ¯</text>
    </button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="paw-loading">
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
    </view>
    <text>æ­£åœ¨åŠ è½½å® ç‰©ä¿¡æ¯...</text>
  </view>

  <!-- åˆ†é¡µ -->
  <view class="pagination" wx:if="{{totalItems > 0}}">
    <button
      class="page-button"
      disabled="{{currentPage === 1}}"
      bindtap="changePage"
      data-page="{{currentPage - 1}}"
    >
      <text class="page-arrow">â—€</text>
      <text>ä¸Šä¸€é¡µ</text>
    </button>

    <view class="page-info">
      <text class="current-page">{{currentPage}}</text>
      <text> / {{totalPages}}</text>
    </view>

    <button
      class="page-button"
      disabled="{{currentPage === totalPages}}"
      bindtap="changePage"
      data-page="{{currentPage + 1}}"
    >
      <text>ä¸‹ä¸€é¡µ</text>
      <text class="page-arrow">â–¶</text>
    </button>

    <view class="page-size-selector">
      <text>æ¯é¡µæ˜¾ç¤º:</text>
      <picker 
        mode="selector" 
        range="{{pageSizeOptions}}" 
        value="{{pageSizeIndex}}" 
        bindchange="handlePageSizeChange"
      >
        <view class="page-size-text">{{pageSize}}</view>
      </picker>
    </view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
  <view class="modal" wx:if="{{showModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{isEditing ? 'ç¼–è¾‘å® ç‰©ä¿¡æ¯' : 'æ·»åŠ å® ç‰©ä¿¡æ¯'}}</text>
        <button class="close-button" bindtap="closeModal">Ã—</button>
      </view>

      <view class="modal-body">
        <scroll-view scroll-y="true" class="form-scroll">
          <view class="form-grid">
            <view class="form-group full-width">
              <text class="form-label">
                <text class="required-star">*</text>åç§°
              </text>
              <input
                type="text"
                value="{{petForm.variety_name}}"
                bindinput="onFormInput"
                data-field="variety_name"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">
                <text class="required-star">*</text>ç±»åˆ«
              </text>
              <picker 
                mode="selector" 
                range="{{formCategoryOptions}}" 
                value="{{petForm.categoryIndex}}" 
                bindchange="onCategoryChange"
              >
                <view class="picker-input">
                  {{petForm.category || 'é€‰æ‹©ç±»åˆ«'}}
                </view>
              </picker>
            </view>

            <view class="form-group full-width">
              <text class="form-label">ä½“å‹</text>
              <input
                type="text"
                value="{{petForm.bodily_form}}"
                bindinput="onFormInput"
                data-field="bodily_form"
                placeholder="å¦‚ï¼šå°å‹ã€ä¸­å‹ã€å¤§å‹"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">èº«é«˜</text>
              <input
                type="text"
                value="{{petForm.height}}"
                bindinput="onFormInput"
                data-field="height"
                placeholder="å¦‚ï¼š20-30cm"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">ä½“é‡</text>
              <input
                type="text"
                value="{{petForm.weight}}"
                bindinput="onFormInput"
                data-field="weight"
                placeholder="å¦‚ï¼š3-5kg"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">å¯¿å‘½</text>
              <input
                type="text"
                value="{{petForm.lifetime}}"
                bindinput="onFormInput"
                data-field="lifetime"
                placeholder="å¦‚ï¼š12-15å¹´"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">å°¾å·´ç‰¹å¾</text>
              <input
                type="text"
                value="{{petForm.feature_tail}}"
                bindinput="onFormInput"
                data-field="feature_tail"
                placeholder="æè¿°å°¾å·´ç‰¹å¾"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">è€³æœµç‰¹å¾</text>
              <input
                type="text"
                value="{{petForm.feature_ear}}"
                bindinput="onFormInput"
                data-field="feature_ear"
                placeholder="æè¿°è€³æœµç‰¹å¾"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">çœ¼ç›ç‰¹å¾</text>
              <input
                type="text"
                value="{{petForm.feature_eye}}"
                bindinput="onFormInput"
                data-field="feature_eye"
                placeholder="æè¿°çœ¼ç›ç‰¹å¾"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">æ¯›è‰²</text>
              <input
                type="text"
                value="{{petForm.coat_color}}"
                bindinput="onFormInput"
                data-field="coat_color"
                placeholder="å¦‚ï¼šé»‘è‰²ã€ç™½è‰²ã€èŠ±è‰²"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">æ¯›é•¿</text>
              <input
                type="text"
                value="{{petForm.coat_length}}"
                bindinput="onFormInput"
                data-field="coat_length"
                placeholder="å¦‚ï¼šçŸ­æ¯›ã€é•¿æ¯›"
              />
            </view>

            <view class="form-group full-width">
              <text class="form-label">å›¾ç‰‡URL</text>
              <input
                type="text"
                value="{{petForm.image}}"
                bindinput="onFormInput"
                data-field="image"
                placeholder="è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥"
              />
            </view>
          </view>

          <view class="form-group full-width">
            <text class="form-label">ç®€ä»‹</text>
            <input
              value="{{petForm.introduction}}"
              bindinput="onFormInput"
              data-field="introduction"
              placeholder="è¯·è¾“å…¥å® ç‰©ç®€ä»‹"
              maxlength="500"
            ></input>
          </view>

          <view class="form-group full-width">
            <text class="form-label">é¥²å…»æ³¨æ„äº‹é¡¹</text>
            <input
              value="{{petForm.feeding_matters}}"
              bindinput="onFormInput"
              data-field="feeding_matters"
              placeholder="è¯·è¾“å…¥é¥²å…»æ³¨æ„äº‹é¡¹"
              maxlength="500"
            ></input>
          </view>

          <view class="form-actions">
            <button class="cancel-button" bindtap="closeModal">å–æ¶ˆ</button>
            <button class="submit-button" bindtap="submitForm">
              {{isEditing ? 'ä¿å­˜ä¿®æ”¹' : 'æ·»åŠ å® ç‰©'}}
            </button>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>

  <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
  <view class="modal" wx:if="{{showDeleteModal}}">
    <view class="modal-content delete-confirm">
      <view class="modal-header">
        <text class="modal-title">ç¡®è®¤åˆ é™¤</text>
        <button class="close-button" bindtap="cancelDelete">Ã—</button>
      </view>

      <view class="modal-body">
        <view class="delete-warning">
          <text class="warning-icon">âš ï¸</text>
        </view>
        <text>ç¡®å®šè¦åˆ é™¤ <text class="highlight">{{petToDelete.variety_name}}</text> çš„ä¿¡æ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</text>

        <view class="form-actions">
          <button class="cancel-button" bindtap="cancelDelete">å–æ¶ˆ</button>
          <button class="delete-confirm-button" bindtap="deletePet">ç¡®è®¤åˆ é™¤</button>
        </view>
      </view>
    </view>
  </view>
</view>